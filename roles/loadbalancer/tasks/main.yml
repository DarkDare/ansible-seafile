# haproxy supports ssl decryption since 1.5
# install the PPA of Debian haproxy Maintainer
# Vincent Bernat (Ubuntu 14.04 LTS only has 1.4)
- name: Install haproxy-1.5 PPA
  apt_repository: 'ppa:vbernat/haproxy-1.5'
  when: ssl_dec_loadbalancer

- name: assemble combined cert-key-file
  assemble: >
    dest=/etc/ssl/seafile-all.pem
    src=ssl
    remote_src=False
    mode=0600
    owner=root
    group=root
  when: ssl_dec_loadbalancer

- name: Install haproxy
  apt: name=haproxy state=present

- name: Configure haproxy
  template: >
    src=haproxy.cfg.j2
    dest=/etc/haproxy/haproxy.cfg
    mode=0644

- name: enable haproxy
  lineinfile: >
    dest=/etc/default/haproxy
    regexp="^ENABLED="
    line="ENABLED=1"

- name: start haproxy
  service: name=haproxy state=started

## haproxyctl
- name: install git
  apt: name=git state=present

- name: install python2.7
  apt: name=python2.7 state=present

- name: Install python-setuptools
  apt: name=python-setuptools state=present

- name: git neurogeek/haproxyctl repo
  git: >
    repo=https://github.com/neurogeek/haproxyctl.git
    dest=/opt/haproxy
  register: get_haproxyctl

- name: install haproxyctl
  command: python setup.py install chdir=/opt/haproxy
  when: get_haproxyctl.changed
